// app/api/kira/webhooks/create_operational_kira/route.ts
// UPDATED: Now sends welcome email after creating the Operational Kira

import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';
import { sendKiraReadyEmail } from '@/lib/email/resend';

const supabase = createClient(
  process.env.SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

const ELEVENLABS_API_KEY = process.env.ELEVENLABS_API_KEY!;
const APP_URL = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000';

// ... (keep existing interfaces and helper functions)

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    
    console.log('[create_operational_kira] Received:', body);

    // ... (existing validation and agent creation logic)

    // After successfully creating the agent and saving to database:
    
    // =========================================
    // NEW: Send Kira Ready Email
    // =========================================
    try {
      // Get user details for email
      const { data: user } = await supabase
        .from('users')
        .select('name, email, journey_type')
        .eq('id', body.user_id)
        .single();

      if (user?.email) {
        await sendKiraReadyEmail({
          userName: user.name || 'there',
          userEmail: user.email,
          agentId: body.agent_id, // The newly created ElevenLabs agent ID
          journeyType: user.journey_type || 'personal',
          primaryGoal: body.primary_goal,
        });
        
        console.log('[create_operational_kira] Welcome email sent to:', user.email);

        // Log the email
        await supabase
          .from('email_logs')
          .insert({
            user_id: body.user_id,
            email_type: 'kira_ready',
            recipient: user.email,
            status: 'sent',
          })
          .catch(() => {}); // Non-critical
      }
    } catch (emailError) {
      // Don't fail the whole request if email fails
      console.error('[create_operational_kira] Email failed (non-critical):', emailError);
    }
    // =========================================

    return NextResponse.json({
      result: {
        success: true,
        agent_id: body.agent_id,
        redirect_url: `/chat/${body.agent_id}`,
        message: "Perfect! Your Kira is ready. Check your email for your personal link!",
      }
    });

  } catch (error) {
    console.error('[create_operational_kira] Error:', error);
    return NextResponse.json({
      result: {
        success: false,
        message: "Something went wrong setting up your Kira. Let's try again.",
      }
    }, { status: 500 });
  }
}

// ============================================================================
// EXAMPLE: Full implementation with email integrated
// ============================================================================

/*
Here's how the full create_operational_kira should look with email integrated:

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { conversation_id, user_id, journey_type, user_name, primary_goal } = body;

    // 1. Get session data from Setup Kira conversation
    const session = setupSessions.get(conversation_id);
    
    // 2. Get or create user
    let { data: user } = await supabase
      .from('users')
      .select('*')
      .eq('id', user_id)
      .single();

    // 3. Generate personalized prompt
    const { systemPrompt, firstMessage } = getKiraPrompt({
      userName: user_name,
      journeyType: journey_type,
      contexts: session?.contexts || [],
      primaryGoal: primary_goal,
    });

    // 4. Create ElevenLabs agent
    const agent = await createElevenLabsAgent({
      name: `Kira_${journey_type}_${user_name}_${Date.now()}`,
      systemPrompt,
      firstMessage,
      tools: [...conversationTools, ...memoryTools],
    });

    // 5. Save to database
    const { data: savedAgent } = await supabase
      .from('kira_agents')
      .insert({
        user_id,
        agent_name: agent.name,
        journey_type,
        elevenlabs_agent_id: agent.agent_id,
      })
      .select()
      .single();

    // 6. Send welcome email
    if (user?.email) {
      await sendKiraReadyEmail({
        userName: user.name || user_name,
        userEmail: user.email,
        agentId: agent.agent_id,
        journeyType: journey_type,
        primaryGoal: primary_goal,
      });
    }

    // 7. Return success
    return NextResponse.json({
      result: {
        success: true,
        agent_id: agent.agent_id,
        redirect_url: `/chat/${agent.agent_id}`,
        message: "Your Kira is ready! Check your email for your personal link.",
      }
    });

  } catch (error) {
    // Handle error
  }
}
*/
